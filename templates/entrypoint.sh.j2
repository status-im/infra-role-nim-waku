#!/usr/bin/env sh

# This script generate a keystore if missing and run the node

{% if nim_waku_rln_keystore_active %}
if test -f {{ nim_waku_rln_keystore_path }}; then
  echo "keystore/keystore.json already exists. Skipping the RLN registration."
else

  # Mint the token used to pay for RLN Membership registration from Linea Sepolia account (This is a generic ERC20 token used for testnet only):
  # The amount of "5000000000000000000" is how much is needed to register with a `rln-relay-user-message-limit` of 100

  cast send $TOKEN_CONTRACT_ADDRESS "mint(address,uint256)" $ETH_TESTNET_ACCOUNT 5000000000000000000 --private-key $ETH_TESTNET_KEY --rpc-url $RLN_RELAY_ETH_CLIENT_ADDRESS

  # Approve the RLN contract to spend tokens on behalf of your account:

  cast send $TOKEN_CONTRACT_ADDRESS "approve(address,uint256)" $RLN_RELAY-ETH-CONTRACT-ADDRESS 5000000000000000000 --private-key $ETH_TESTNET_KEY --rpc-url $RLN_RELAY_ETH_CLIENT_ADDRESS

  ## Performs the RLN registration if the keystore.json credentials file does not exist
  mkdir -p $(dirname {{ nim_waku_rln_keystore_path }})
  exec /usr/bin/wakunode generateRlnKeystore \
      --rln-relay-eth-client-address={{ nim_waku_rln_relay_eth_client_address }} \
      --rln-relay-eth-private-key={{ nim_waku_rln_account_key | mandatory }} \
      --rln-relay-eth-contract-address={{nim_waku_rln_relay_eth_contract_address}} \
      --rln-relay-cred-path='{{ nim_waku_rln_keystore_path }}' \
      --rln-relay-cred-password='{{ nim_waku_rln_cred_password | mandatory }}' \
      --rln-relay-user-message-limit=100 \
     --execute
fi
{% endif %}

exec /usr/bin/wakunode "${@}"
